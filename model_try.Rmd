---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(fda)
library(tidyverse)
library(plotly)
library(dplyr)
library(fdapace)
library(aplpack)
```

Data wrangle, preparation and visualization:

```{r}
ID_AP_GRF_stance_N <- cbind(ID_info, AP_GRF_stance_N)
ID_ML_GRF_stance_N <- cbind(ID_info, ML_GRF_stance_N)
ID_V_GRF_stance_N <- cbind(ID_info, V_GRF_stance_N)
ID_COPx_stance <- cbind(ID_info, COPx_stance)
ID_COPy_stance <- cbind(ID_info, COPy_stance)

data_pre_func <- function(df){ 
  df1<- df %>% pivot_longer(-c(ID, KNEE, TRIAL, tr_length), names_to = "time", values_to = "force") %>% 
    mutate(new = paste(ID, "-",KNEE, "-",TRIAL))
  
  t <- rep(seq(0,100,length.out = 100),15696)
  
  df_pre <- cbind(df1, t)
  return(df_pre)
}

try <- data_pre_func(ID_AP_GRF_stance_N)
try2 <- data_pre_func(ID_ML_GRF_stance_N)
try3 <- data_pre_func(ID_V_GRF_stance_N)
try4 <- data_pre_func(ID_COPx_stance)
try5 <- data_pre_func(ID_COPy_stance)

# p_try <- ggplot(try, aes(x = t, y = force, group = new, col = new)) +
#   geom_line()
# p_try
```

Prepare data for FPCA:
```{r}
L_try <- MakeFPCAInputs(try$new, try$t, try$force)
FPCAdense <- FPCA(L_try$Ly, L_try$Lt)

# Plot the FPCA object
plot(FPCAdense)
```

Based on the scree-plot we see that the first three components appear to encapsulate most of the relevant variation. The number of eigen components to reach a 99% FVE is 12 but just 7 eigen components are enough to reach a 95.0%.

```{r}
SelectK(FPCAdense, criterion = 'FVE', FVEthreshold = 0.95)
SelectK(FPCAdense, criterion = 'FVE', FVEthreshold = 0.99)
```

```{r}
library(ks)

par(mfrow=c(1,2))
  CreatePathPlot(FPCAdense,subset = c(3,5,135), K = 12, main = 'K = 12', pch = 4); grid()
  CreatePathPlot(FPCAdense, subset = c(3,5,135), K = 7, main = 'K = 7', pch = 4) ; grid()
```

perform outlier detection:

```{r}
par(mfrow=c(1,1))
  CreateOutliersPlot(FPCAdense, optns = list(K = 12, variant = 'KDE'))
```


visualize data using a functional box-plot
```{r}
CreateFuncBoxPlot(FPCAdense, xlab = 'Stance time', ylab = 'VGRF force', optns = list(K = 7, variant='KDE'))
```

```{r}
# TS cluster
library(dtwclust)
pc <- tsclust(L_try$Ly, type = "partitional", k = 4, 
              distance = "dtw_basic", centroid = "pam", 
              seed = 3247L, trace = TRUE,
              args = tsclust_args(dist = list(window.size = 4)))


plot(pc, type = "centroids", clus = 1L)

t(cbind(emissions[,0], cluster = clust.pam@cluster))
```



