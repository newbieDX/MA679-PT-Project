---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(fda)
library(tidyverse)
library(plotly)
library(dplyr)
library(fdapace)
library(aplpack)
```

Data wrangle, preparation and visualization:

```{r}
ID_AP_GRF_stance_N <- cbind(ID_info, AP_GRF_stance_N)

left_2 <- subset(ID_AP_GRF_stance_N, ID_AP_GRF_stance_N$KNEE == "LEFT" & ID_AP_GRF_stance_N$TRIAL == 2)
left_2 <- left_2 %>% pivot_longer(-c(ID, KNEE, TRIAL, tr_length), names_to = "time", values_to = "force")
left_2$time <- gsub('^.', '', left_2$time)


t <- rep(seq(0,100,length.out = 100),2070)


left_2 <- cbind(left_2, t)


p_try <- ggplot(left_2, aes(x = t, y = force, group = ID, col = ID)) +
  geom_line()
p_try
```

Prepare data for FPCA:

```{r}
L_try <- MakeFPCAInputs(b$ID, b$t, b$force)
FPCAdense <- FPCA(L_try$Ly, L_try$Lt)

# Plot the FPCA object
plot(FPCAdense)
```

Based on the scree-plot we see that the first three components appear to encapsulate most of the relevant variation. The number of eigen components to reach a 99% FVE is 13 but just 7 eigen components are enough to reach a 95.0%.

```{r}
SelectK(FPCAdense, criterion = 'FVE', FVEthreshold = 0.95)
SelectK(FPCAdense, criterion = 'FVE', FVEthreshold = 0.99)
```

```{r}
library(ks)

par(mfrow=c(1,2))
  CreatePathPlot(FPCAdense, subset = c(3,5,135), main = 'K = 13', pch = 4); grid()
  CreatePathPlot(FPCAdense, subset = c(3,5,135), K = 7, main = 'K = 7', pch = 4) ; grid()

```

perform outlier detection:

```{r}
par(mfrow=c(1,1))
  CreateOutliersPlot(FPCAdense, optns = list(K = 7, variant = 'KDE'))
```


visualize data using a functional box-plot
```{r}
CreateFuncBoxPlot(FPCAdense, xlab = 'Stance time', ylab = 'VGRF force', optns = list(K = 7, variant='KDE'))
```



