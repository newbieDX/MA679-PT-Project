---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(fda)
library(tidyverse)
library(plotly)
library(dplyr)
library(fdapace)
library(aplpack)
```

Data wrangle, preparation and visualization:

```{r}
ID_AP_GRF_stance_N <- cbind(ID_info, AP_GRF_stance_N)
ID_ML_GRF_stance_N <- cbind(ID_info, ML_GRF_stance_N)
ID_V_GRF_stance_N <- cbind(ID_info, V_GRF_stance_N)
ID_COPx_stance <- cbind(ID_info, COPx_stance)
ID_COPy_stance <- cbind(ID_info, COPy_stance)

dt.1 <-  sort(sample(nrow(ID_AP_GRF_stance_N), nrow(ID_AP_GRF_stance_N)*.7))
train.AP<-ID_AP_GRF_stance_N[dt.1,]
test.AP<-ID_AP_GRF_stance_N[-dt.1,]

dt.2 <- sort(sample(nrow(ID_ML_GRF_stance_N), nrow(ID_ML_GRF_stance_N)*.7))
train.ML<-ID_ML_GRF_stance_N[dt.1,]
test.ML<-ID_ML_GRF_stance_N[-dt.1,]

data_pre_func <- function(df){ 
  df1<- df %>% pivot_longer(-c(ID, KNEE, TRIAL, tr_length), names_to = "time", values_to = "force") %>% 
    mutate(new = paste(ID, "-",KNEE, "-",TRIAL))
  
  t <- rep(seq(0,100,length.out = 100),nrow(df))
  
  df_pre <- cbind(df1, t)
  return(df_pre)
}

try <- data_pre_func(train.AP)
try2 <- data_pre_func(train.ML)
try3 <- data_pre_func(ID_V_GRF_stance_N)
try4 <- data_pre_func(ID_COPx_stance)
try5 <- data_pre_func(ID_COPy_stance)

# p_try <- ggplot(try, aes(x = t, y = force, group = new, col = new)) +
#   geom_line()
# p_try
```

Prepare data for FPCA:
```{r}
L_try <- MakeFPCAInputs(try$new, try$t, try$force)
FPCAdense <- FPCA(L_try$Ly, L_try$Lt)

# Plot the FPCA object
plot(FPCAdense)

# Select the first PCs:
AP_stance_dr <- FPCAdense$xiEst[,1:3]
colnames(AP_stance_dr) <- c('AP_PC1', 'AP_PC2', 'AP_PC3')
```

Based on the scree-plot we see that the first three components appear to encapsulate most of the relevant variation. The number of eigen components to reach a 99% FVE is 12 but just 7 eigen components are enough to reach a 95.0%.

```{r}
SelectK(FPCAdense, criterion = 'FVE', FVEthreshold = 0.95)
SelectK(FPCAdense, criterion = 'FVE', FVEthreshold = 0.99)
```

```{r}
library(ks)

par(mfrow=c(1,2))
  CreatePathPlot(FPCAdense,subset = c(3,5,135), K = 12, main = 'K = 12', pch = 4); grid()
  CreatePathPlot(FPCAdense, subset = c(3,5,135), K = 7, main = 'K = 7', pch = 4) ; grid()
```

perform outlier detection:

```{r}
par(mfrow=c(1,1))
  CreateOutliersPlot(FPCAdense, optns = list(K = 7, variant = 'KDE'))
```


visualize data using a functional box-plot
```{r}
CreateFuncBoxPlot(FPCAdense, xlab = 'Stance time', ylab = 'VGRF force', optns = list(K = 7, variant='KDE'))
```

```{r}
library(EMCluster)
FClust(L_try$Ly, L_try$Lt, k = 4, cmethod = "EMCluster", optnsFPCA = NULL, optnsCS = NULL)
```


```{r}
library(corrplot)
corrplot(FPCAdense$fittedCorr, method="color")
```





